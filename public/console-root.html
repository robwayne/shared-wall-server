<!DOCTYPE html>
<html lang="en" dir="rtl">
  <head>
    <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/addons/p5.dom.min.js"></script>

    <script
			  src="https://code.jquery.com/jquery-3.6.0.min.js"
			  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
			  crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">
    <title>Master Client: Shared Drawing Wall Server</title>
    <link rel="stylesheet" href="index.css">
    <style>
      .masterActiveCell{
        background: transparent;
        cursor: pointer;
        border: 4px solid Blue;
      }

      .toolbarBtn {
        max-width: 90%;
        padding: 5px;
        text-align: center;
        height: 30px;
        cursor: pointer;
        background-color: transparent;
        border: 2px solid #e78a1f;
        color: #e78a1f;
      }

      .toolbarBtn:hover {
        background-color: #e78a1f;
        color: #fff;
        border: #fff;
      }

      .toolbarBtn:last-of-type {
        background-color: transparent;
        border: 2px solid #eb2626;
        color: #eb2626;
      }

      .toolbarBtn:last-of-type:hover {
        background-color: #eb2626;
        color: #fff;
        border: #fff;
      }

      #masterToolbar {
        padding-top: 10px;
        border: 2px solid black;
        position: fixed;
        z-index: 10000;
        background: #fff;
        top: 120px;
        right: 10px;
        min-width: 200px;
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
      }

      #clientMsgForm {
        height: 50px;
        width: 100%;
        min-width: 100%;
        max-width: 100%;
      }

      #clientMsgForm input[type=text] {
        height: 90%;
        max-width: 75%;
      }

      .cellDisabled {
        background: transparent;
        cursor: pointer;
        border: 4px solid #727272;
      }

    </style>
    <script type="text/javascript">

      let socket;
      const loopbackURLs = ['localhost', '127.0.0.1'];
      const development = loopbackURLs.includes(window.location.hostname);
      const connectURL = development ? "http://localhost:3000" : "https://midarom.herokuapp.com";
      var dispScale = 0.5;
      var pg;
      var pd;

      var col = [0,0,255];
      var pos = {x:0, y:0, px:0, py:0, scl:dispScale};
      var youtubeId = "21X5lGlDOfg";
      var embedAddress = "https://www.youtube.com/embed/" + youtubeId +  "?autoplay=1&mute=1&wmode=opaque&showinfo=0&controls=0";
      let canvasStatus = "1111111111";
      let username;

      var _color = "#000000";
      var _weight = 1;

      var cellW;
      var cellH;
      var cellX;
      var cellY;
      var rows = 4;
      var cols = 5;

      var cellpositions = [[0,0], [2, 0], [4, 0], [1,1], [3,1], [0,2], [2, 2], [4,2], [1,3], [3,3]];

      var activeCell = -1;

      var projectorMode = false;
      let shouldClearDrawing = false;
	    
      const urlParams = new URLSearchParams(window.location.search);

      var vid;
      $(function() {
        vid = $("#youtubeVid");

        username = urlParams.get('uid');
        var liveLink = urlParams.get('id');

        if(liveLink != null){
          youtubeId = liveLink;
          embedAddress = "https://www.youtube.com/embed/" + youtubeId +  "?autoplay=1&mute=1&wmode=opaque&showinfo=0&controls=0";
          vid.attr('src', embedAddress);
        }

        var proj = urlParams.get('projector');
        if(proj != null){
          if(proj == 1){
            projectorMode = true;
          }
        }

        $("#masterToolbar").hide();
        socket = io.connect(connectURL);

        $("#clientMsgForm").submit((event) => {
          const message  = $('#msgInput').val();
          console.log("message", message);
          if (message) {
            messageClient(message);
          }
          $('#msgInput').val('');
          event.preventDefault();
        });
      });

      function requestCell(id){
        selectClientCell(id);
      }

      const replaceAt = (str, index, char) => {
          return str.substr(0, index) + char + str.substr(index + char.length);
      }

      function setup(){
        let cnv = createCanvas(1920, 1080);
        pg = createGraphics(width, height);
        pd = createGraphics(width/5, height/4);
        cnv.parent('p5Container');
        smooth(4);

        if(projectorMode){
          $("body").css("background", "#000");
          $(".buttonGrid").css("display", "none");
          setScale(1);
          $(".main").css("margin", 0);
          $("header").css("display", "none");
          $(".youtubeContainer").css("display", "none");
        }else{
          setScale(0.5);
        }

        // Callback function
        socket.on('mouse', (data) => {
          // if (canvasIndex && p5Instances[canvasIndex].parent() )

          const {_col, x, y, px, py, _weight, canvasIndex} = data;
          const c = _col || "#000000";
          // pg.stroke(color(_col));
          // pg.strokeWeight(strokeWidth);
          pg.strokeWeight(_weight);
          pg.stroke(color(c));
          // pg.line(px - cellX, py-cellY, x-cellX, y-cellY);
          pg.line(px, py, x, y);
        })

        socket.emit('registerUsername', {username});
      }

      function draw(){

        clear();

        // draw all the canvases
        cellW = width*1/cols;
        cellH = height*1/rows;

        var counter = 0;
        var canvasCounter = 0;

        for(var i = 0; i < rows; i ++){
          for(var j = 0; j < cols; j ++){

            if(counter%2 == 0 ){
              push();
              fill(255);
              noStroke();
              if(canvasStatus[canvasCounter] == 1){

              }
              translate(j*cellW, i*cellH);
              rect(0,0, cellW, cellH);
              pop();
              canvasCounter++;
            }
            counter++;
          }
        }

        // the drawing layer
        image(pg, 0, 0, width, height);

        if(projectorMode){
          return;
        }

        if(activeCell > -1){
          image(pd, cellX, cellY);
        }

        if (shouldClearDrawing) {
          clearDrawings();
          shouldClearDrawing = false;
        }

      }

      function clearDrawings(){
        pg.clear();
        pd.clear();
        clear();
        background(255);
      }

      function setScale(scl){

        dispScale = scl;

        $(".main").css("width", 1920*dispScale);
        $(".main").css("height", 1080*dispScale);

        $("#defaultCanvas0").css("width", 1920*dispScale);
        $("#defaultCanvas0").css("height", 1080*dispScale);

        vid.css("width", 1920*dispScale);
        vid.css("height", 1080*dispScale);
      }

      const isCellDisabled = (cellId) => {
        return (canvasStatus[cellId] === '2');
      }

      const selectClientCell = (id) => {
        // show the toolbar
        // select cell to interface with. 
        pd.clear();
        activeCell = id;
        // scroll to element
        $(".cellBtn").eq(id).addClass("masterActiveCell");
        if (isCellDisabled(id)) {
          $("#disableCellBtn").text('Reenable cell');
        } else {
          $("#disableCellBtn").text('Disable cell');
        }
        $("#masterToolbar").show();
      }

      const disableCell = () => {
        if (activeCell !== -1) {
          socket.emit('disableCellForClients', { clientCellIndex: activeCell, username }, (ack) => {
            if (ack === "ok") {
              canvasStatus = replaceAt(canvasStatus, activeCell, '2');
              $(".cellBtn").eq(activeCell).removeClass("busy").removeClass("free").addClass("cellDisabled");
              $("#disableCellBtn").text('Reenable cell');
            }
          });
        }
      };

      const reenableCell = () => {
        if (activeCell !== -1) {
          socket.emit('reenableCellForClients', { clientCellIndex: activeCell, username }, (ack) => {
            if (ack === "ok") {
              $(".cellBtn").eq(activeCell).removeClass("cellDisabled").addClass('free');
              $("#disableCellBtn").text('Disable cell');
            }
          });
        }
      };

      const disconnectClient = () => {
        socket.emit('disconnectClient', {clientCellIndex: activeCell, username}, (ack) => {
          if (ack === 'ok') {
            giveUpCell();
            alert('Client Disconnected');
          } else {
            alert("Could not disconnect client: " + ack)
          }
        });  
      };

      const messageClient = (clientMessage) => {
        socket.emit('messageClient', {clientCellIndex: activeCell, username, messageForClient: clientMessage}, (ack) => {
          console.log(ack);
        })  
      }

      const clearAllDrawings = () => {
        console.log("sending CLEAR ALL message")
        socket.emit('clearAll', {username}, (ack) => {
          if (ack === "ok") {
            shouldClearDrawing = true;
          }
        });  
      };

      const clearClientDrawing = () => {
        socket.emit('clearClientDrawing', {username, clientCellIndex: activeCell}, (ack) => {
          console.log(ack);
        });  
      };

      const giveUpCell = () => {
        pg.image(pd, cellX, cellY);
        // tell the server to give up this cell
        $(".cellBtn").eq(activeCell).removeClass("masterActiveCell");
        // $(".cellBtn").removeClass("activeCell");
        activeCell = -1;
        $("#masterToolbar").hide();
      }

      const toggleCellInteraction = () => {
        if (isCellDisabled(activeCell)) {
          reenableCell();
        } else {
          disableCell();
        }
      };

      // request to draw on cell
      function cellClick(id){
        if(activeCell != id) {
          if(activeCell != -1) {
            giveUpCell();
          }
          selectClientCell(id);
        }
      }
      
    </script>
  </head>
  <body>

    <header dir="rtl">
      <h1>Master</h1>
      <h3>לחצ/י על אחד מהריבועים כדי לפתוח את תפריט האפשרויות</h3>
    </header>

    <div id="masterToolbar">
      <div class="toolbarBtn" onclick="giveUpCell()">ביטול בחירה</div>
      <div class="toolbarBtn" onclick="clearAllDrawings()">נקהו ציור</div>
      <div class="toolbarBtn" id="disableCellBtn" onclick="toggleCellInteraction()" >Disable cell</div>
      <div class="toolbarBtn" onclick="disconnectClient()" >נתק/י משתמש</div>
      <form id="clientMsgForm" action="">
        <label for="msgInput">שלח/י הודעה:</label>
        <input id="msgInput" type="text" name="msgInput" placeholder="הודעה">
        <input type="submit" value="שלח/י">
    </form>
    </div>

    <div class="main">

      <div class="overlay">
        <div class="buttonGrid">
          <div class="cellBtn free" onclick="cellClick(0)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(1)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(2)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(3)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(4)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(5)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(6)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(7)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(8)"></div>  <div class="cellspace"></div>
          <div class="cellBtn free" onclick="cellClick(9)"></div>  <div class="cellspace"></div>
        </div>

        <div id="p5Container">

        </div>

      </div>
      <div class="youtubeContainer">
          <iframe id="youtubeVid" width="1920" height="1080" src="https://www.youtube.com/embed/21X5lGlDOfg?autoplay=1&mute=1&wmode=opaque&showinfo=0&controls=0" autoplay title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ></iframe>
      </div>
    </div>
  </body>
</html>
